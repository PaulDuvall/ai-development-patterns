version: '3.8'

# Security Sandbox - complete network isolation for AI development
# Based on the Security Sandbox pattern from README.md

services:
  ai-development:
    build:
      context: .
      dockerfile: Dockerfile.ai-sandbox
    container_name: ai-dev-sandbox

    # Complete network isolation - no egress or ingress
    network_mode: none

    # Security constraints
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false

    # Volume mounts - read-only source, read/write for AI outputs and logs
    volumes:
      - ./src:/workspace/src:ro
      - ./generated:/workspace/generated:rw
      - ./logs:/workspace/logs:rw

      # DO NOT mount sensitive directories:
      # - ~/.aws (AWS credentials)
      # - ~/.ssh (SSH keys)
      # - .env files (environment secrets)
      # - /var/run/docker.sock (Docker daemon)

    # Environment variables - development only, no secrets
    environment:
      - AI_SANDBOX=true
      - WORKSPACE_DIR=/workspace
      - PYTHONPATH=/workspace/src
      - LOG_LEVEL=INFO

    # Prevent container from restarting automatically
    restart: no

    # Resource limits to prevent exhaustion
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G

    healthcheck:
      test: ["CMD", "python3", "/workspace/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    working_dir: /workspace

    # User context - run as non-root user (must match Dockerfile UID)
    user: "1000:1000"

    # Keep container running for interactive use
    command: ["/bin/bash", "-c", "/workspace/init-workspace.sh && tail -f /dev/null"]

    labels:
      - "ai.sandbox=true"
      - "ai.network.isolated=true"
      - "ai.security.level=high"
      - "version=1.0"
